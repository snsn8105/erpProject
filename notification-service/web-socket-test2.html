<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket ì•Œë¦¼ í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }
        .notification {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .notification-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
        }
        .timestamp {
            color: #666;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”” WebSocket ì•Œë¦¼ í…ŒìŠ¤íŠ¸</h1>
    
    <div class="container">
        <h2>ì—°ê²° ì„¤ì •</h2>
        <div>
            <label>ì§ì› ID: </label>
            <input type="number" id="employeeId" placeholder="ì˜ˆ: 1" value="1">
        </div>
        <br>
        <button id="connectBtn" onclick="connect()">ì—°ê²°</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>ì—°ê²° í•´ì œ</button>
        <div id="status" class="status disconnected">ì—°ê²° ì•ˆë¨</div>
    </div>
    
    <div class="container">
        <h2>ìˆ˜ì‹ í•œ ì•Œë¦¼</h2>
        <div id="notifications" class="notification-list">
            <p style="color: #999;">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
        <button onclick="clearNotifications()">ì•Œë¦¼ ì§€ìš°ê¸°</button>
    </div>
    
    <div class="container">
        <h2>í…ŒìŠ¤íŠ¸</h2>
        <button onclick="sendTestNotification()">í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë°›ê¸°</button>
        <button onclick="checkStatus()">ì—°ê²° ìƒíƒœ í™•ì¸</button>
    </div>

    <script>
        let stompClient = null;
        let employeeId = null;
        let notificationCount = 0;

        function connect() {
            employeeId = document.getElementById('employeeId').value;
            
            if (!employeeId) {
                alert('ì§ì› IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            // SockJSë¥¼ í†µí•œ WebSocket ì—°ê²°
            const socket = new SockJS('http://localhost:8084/ws');
            stompClient = Stomp.over(socket);
            
            // ì—°ê²° í—¤ë”ì— employeeId í¬í•¨
            const headers = {
                'employeeId': employeeId
            };

            stompClient.connect(headers, function(frame) {
                console.log('Connected: ' + frame);
                updateStatus(true);
                
                // ê°œì¸ ì•Œë¦¼ êµ¬ë…
                stompClient.subscribe('/topic/notifications/' + employeeId, function(message) {
                    showNotification(JSON.parse(message.body));
                });
                
                // ì „ì²´ ì•Œë¦¼ êµ¬ë… (ì˜µì…˜)
                stompClient.subscribe('/topic/notifications/all', function(message) {
                    showNotification(JSON.parse(message.body));
                });
                
                console.log('êµ¬ë… ì™„ë£Œ: employeeId=' + employeeId);
            }, function(error) {
                console.error('Connection error:', error);
                updateStatus(false);
                alert('ì—°ê²° ì‹¤íŒ¨: ' + error);
            });
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect(function() {
                    console.log('Disconnected');
                    updateStatus(false);
                });
            }
        }

        function updateStatus(connected) {
            const statusDiv = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            if (connected) {
                statusDiv.className = 'status connected';
                statusDiv.textContent = 'ì—°ê²°ë¨ (ì§ì› ID: ' + employeeId + ')';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                statusDiv.className = 'status disconnected';
                statusDiv.textContent = 'ì—°ê²° ì•ˆë¨';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        function showNotification(notification) {
            notificationCount++;
            
            const notificationsDiv = document.getElementById('notifications');
            
            // ì²« ì•Œë¦¼ì´ë©´ ê¸°ë³¸ ë©”ì‹œì§€ ì œê±°
            if (notificationCount === 1) {
                notificationsDiv.innerHTML = '';
            }
            
            const notificationDiv = document.createElement('div');
            notificationDiv.className = 'notification';
            
            let html = '<strong>ì•Œë¦¼ #' + notificationCount + '</strong><br>';
            html += 'Approval ID: ' + (notification.approvalId || 'N/A') + '<br>';
            html += 'í˜„ì¬ ë‹¨ê³„: ' + (notification.currentStep || 'N/A') + '<br>';
            html += 'ë‹¨ê³„ ê²°ê³¼: ' + (notification.result || 'N/A') + '<br>';
            html += 'ìµœì¢… ìƒíƒœ: ' + (notification.finalResult || 'N/A') + '<br>';
            
            if (notification.rejectedBy) {
                html += 'ë°˜ë ¤ì ID: ' + notification.rejectedBy + '<br>';
            }
            
            if (notification.title) {
                html += 'ì œëª©: ' + notification.title + '<br>';
            }
            
            html += '<strong>ë©”ì‹œì§€: ' + (notification.message || 'N/A') + '</strong><br>';
            html += '<span class="timestamp">' + new Date(notification.timestamp).toLocaleString() + '</span>';
            
            notificationDiv.innerHTML = html;
            notificationsDiv.insertBefore(notificationDiv, notificationsDiv.firstChild);
            
            console.log('ì•Œë¦¼ ìˆ˜ì‹ :', notification);
        }

        function clearNotifications() {
            document.getElementById('notifications').innerHTML = '<p style="color: #999;">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            notificationCount = 0;
        }

        async function sendTestNotification() {
            if (!employeeId) {
                alert('ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”.');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:8084/api/notifications/test/' + employeeId);
                const result = await response.text();
                console.log('í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ìš”ì²­:', result);
                alert('í…ŒìŠ¤íŠ¸ ì•Œë¦¼ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨:', error);
                alert('í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: ' + error);
            }
        }

        async function checkStatus() {
            if (!employeeId) {
                alert('ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”.');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:8084/api/notifications/status/' + employeeId);
                const status = await response.json();
                
                const message = `
ì§ì› ID: ${status.employeeId}
ì—°ê²° ìƒíƒœ: ${status.connected ? 'ì—°ê²°ë¨' : 'ì—°ê²° ì•ˆë¨'}
ì„¸ì…˜ ìˆ˜: ${status.sessionCount}
                `;
                
                alert(message);
                console.log('ì—°ê²° ìƒíƒœ:', status);
            } catch (error) {
                console.error('ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
                alert('ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ' + error);
            }
        }

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì—°ê²° í•´ì œ
        window.addEventListener('beforeunload', function() {
            disconnect();
        });
    </script>
</body>
</html>